<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¼ WebRTC Baby Monitor Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body style="font-family: Arial; background: #f0f0f0; margin: 0; padding: 20px;">
    <div style="max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px;">
        <h1>ğŸ¼ WebRTC Baby Monitor Test</h1>
        
        <div style="margin: 20px 0;">
            <h3>Durum:</h3>
            <div id="status" style="padding: 10px; background: #f8f9fa; border-radius: 5px;">
                BaÄŸlantÄ± bekleniyor...
            </div>
        </div>
        
        <div style="margin: 20px 0;">
            <video id="localVideo" width="300" height="200" autoplay muted style="border: 2px solid #ccc; border-radius: 5px; margin-right: 20px;"></video>
            <video id="remoteVideo" width="300" height="200" autoplay style="border: 2px solid #ccc; border-radius: 5px;"></video>
        </div>
        
        <div style="margin: 20px 0;">
            <button onclick="startTest()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                ğŸ“¹ Kamera Test
            </button>
            <button onclick="startConnection()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                ğŸ”— WebRTC BaÄŸlan
            </button>
        </div>
        
        <div id="logs" style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: scroll;">
            <strong>Debug LoglarÄ±:</strong><br>
        </div>
    </div>

    <script>
        const socket = io();
        let localStream;
        let peerConnection;
        
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        
        function log(message) {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logs.innerHTML += `[${time}] ${message}<br>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
            log("Status: " + message);
        }
        
        // Socket events
        socket.on('connect', function() {
            updateStatus('âœ… Sunucuya baÄŸlandÄ±');
        });
        
        socket.on('disconnect', function() {
            updateStatus('âŒ Sunucu baÄŸlantÄ±sÄ± kesildi');
        });
        
        socket.on('offer', handleOffer);
        socket.on('answer', handleAnswer);
        socket.on('ice_candidate', handleIceCandidate);
        
        async function startTest() {
            try {
                log("Kamera eriÅŸimi isteniyor...");
                
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 },
                    audio: true
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                updateStatus('âœ… Kamera Ã§alÄ±ÅŸÄ±yor');
                log("Kamera baÅŸarÄ±yla baÅŸlatÄ±ldÄ±");
                
            } catch (error) {
                updateStatus('âŒ Kamera hatasÄ±: ' + error.message);
                log("Kamera hatasÄ±: " + error.message);
            }
        }
        
        async function startConnection() {
            if (!localStream) {
                alert('Ã–nce kamera testini yapÄ±n!');
                return;
            }
            
            try {
                log("WebRTC baÄŸlantÄ±sÄ± baÅŸlatÄ±lÄ±yor...");
                
                peerConnection = new RTCPeerConnection(config);
                
                // Local stream'i ekle
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                    log("Track eklendi: " + track.kind);
                });
                
                // Remote stream handler
                peerConnection.ontrack = function(event) {
                    log("Remote track alÄ±ndÄ±");
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                    updateStatus('âœ… Video akÄ±ÅŸÄ± baÅŸladÄ±');
                };
                
                // ICE candidate handler
                peerConnection.onicecandidate = function(event) {
                    if (event.candidate) {
                        log("ICE candidate gÃ¶nderiliyor");
                        socket.emit('ice_candidate', event.candidate);
                    }
                };
                
                // Connection state handler
                peerConnection.onconnectionstatechange = function() {
                    log("Connection state: " + peerConnection.connectionState);
                    updateStatus('BaÄŸlantÄ± durumu: ' + peerConnection.connectionState);
                };
                
                // Offer oluÅŸtur ve gÃ¶nder
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.emit('offer', offer);
                
                log("Offer gÃ¶nderildi");
                updateStatus('ğŸ”„ BaÄŸlantÄ± teklifi gÃ¶nderildi');
                
            } catch (error) {
                updateStatus('âŒ WebRTC hatasÄ±: ' + error.message);
                log("WebRTC hatasÄ±: " + error.message);
            }
        }
        
        async function handleOffer(offer) {
            try {
                log("Offer alÄ±ndÄ±, cevap hazÄ±rlanÄ±yor...");
                
                if (!peerConnection) {
                    peerConnection = new RTCPeerConnection(config);
                    
                    peerConnection.ontrack = function(event) {
                        log("Remote track alÄ±ndÄ±");
                        document.getElementById('remoteVideo').srcObject = event.streams[0];
                        updateStatus('âœ… Video akÄ±ÅŸÄ± baÅŸladÄ±');
                    };
                    
                    peerConnection.onicecandidate = function(event) {
                        if (event.candidate) {
                            socket.emit('ice_candidate', event.candidate);
                        }
                    };
                }
                
                await peerConnection.setRemoteDescription(offer);
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('answer', answer);
                
                log("Answer gÃ¶nderildi");
                
            } catch (error) {
                log("Offer handle hatasÄ±: " + error.message);
            }
        }
        
        async function handleAnswer(answer) {
            try {
                log("Answer alÄ±ndÄ±");
                await peerConnection.setRemoteDescription(answer);
                updateStatus('ğŸ”— WebRTC baÄŸlantÄ±sÄ± kuruldu!');
            } catch (error) {
                log("Answer handle hatasÄ±: " + error.message);
            }
        }
        
        async function handleIceCandidate(candidate) {
            try {
                await peerConnection.addIceCandidate(candidate);
                log("ICE candidate eklendi");
            } catch (error) {
                log("ICE candidate hatasÄ±: " + error.message);
            }
        }
        
        window.addEventListener('load', function() {
            log("Sayfa yÃ¼klendi, hazÄ±r");
            updateStatus('Sayfa hazÄ±r - kamera testini baÅŸlatÄ±n');
        });
    </script>
</body>
</html>